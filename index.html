<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>WhatsApp Style Firebase Chat</title>

<style>
body{
margin:0;
font-family:sans-serif;
background:#0b141a;
color:white;
}

.light{
background:#f0f2f5;
color:black;
}

header{
padding:10px;
background:#202c33;
display:flex;
justify-content:space-between;
}

.light header{
background:#e4e6eb;
}

#chat{
height:75vh;
overflow-y:auto;
padding:10px;
}

.msg{
padding:8px 12px;
margin:5px;
border-radius:10px;
max-width:70%;
display:inline-block;
}

.me{
background:#005c4b;
float:right;
clear:both;
}

.other{
background:#202c33;
float:left;
clear:both;
}

.light .other{
background:#d9d9d9;
}

input{
width:70%;
padding:10px;
border:none;
outline:none;
}

button{
padding:10px;
border:none;
cursor:pointer;
border-radius:6px;
}

.controls{
display:flex;
padding:10px;
gap:5px;
}

.userColor1{ background:#ff6b6b }
.userColor2{ background:#4ecdc4 }
.userColor3{ background:#ffd93d }
.userColor4{ background:#6c5ce7 }

#typing{
font-size:12px;
opacity:0.7;
margin-left:10px;
}

</style>
</head>

<body>

<header>
<div>
Room: <span id="roomLabel">None</span> |
Users: <span id="userCount">0</span>
</div>

<div>
<button onclick="toggleTheme()">ðŸŒ™</button>
</div>
</header>

<div id="chat"></div>
<div id="typing"></div>

<div class="controls">
<input id="msgInput" placeholder="Type message..." oninput="typing()">
<button onclick="sendMsg()">âž¤</button>
<button onclick="startVoice()">ðŸŽ¤</button>
<button onclick="leaveRoom()">ðŸšª</button>
</div>

<audio id="joinSound" src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg"></audio>
<audio id="leaveSound" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
getDatabase,
ref,
push,
set,
onValue,
remove,
update
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
apiKey: "AIzaSyC4mYZ5G-WCjt7wAN0G6_B6rh1LDM10U0Q",
authDomain: "chat-data-59467.firebaseapp.com",
databaseURL: "https://chat-data-59467-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "chat-data-59467",
storageBucket: "chat-data-59467.firebasestorage.app",
messagingSenderId: "237808362163",
appId: "1:237808362163:web:52d25dfbffaffde12446c6"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let room = "";
let userId = "User" + Math.floor(Math.random()*9999);
let destroyTime = 0;
let mediaRecorder;
let voiceChunks = [];

joinRoom();

function joinRoom(){
room = prompt("Enter Room ID");
if(!room){
alert("Invalid Room ID");
location.reload();
return;
}

if(confirm("Create Room?")){
let min = prompt("Auto destroy room after minutes? (0 = no destroy)");
destroyTime = Number(min) || 0;
}

document.getElementById("roomLabel").innerText = room;

const userRef = ref(db, "rooms/"+room+"/users/"+userId);
set(userRef, true);

document.getElementById("joinSound").play();

listenMessages();
listenUsers();

if(destroyTime > 0){
setTimeout(()=>{
remove(ref(db,"rooms/"+room));
alert("Room Destroyed");
location.reload();
}, destroyTime*60000);
}
}

function listenMessages(){
const msgRef = ref(db,"rooms/"+room+"/messages");

onValue(msgRef,snap=>{
const chat = document.getElementById("chat");
chat.innerHTML="";

snap.forEach(m=>{
let data = m.val();
let div = document.createElement("div");
div.className="msg "+(data.user===userId?"me":"other");
div.innerHTML = "<b>"+data.user+"</b><br>"+(data.text||"ðŸŽ¤ Voice Message");
chat.appendChild(div);
});

chat.scrollTop = chat.scrollHeight;
});
}

function listenUsers(){
const userRef = ref(db,"rooms/"+room+"/users");

onValue(userRef,snap=>{
document.getElementById("userCount").innerText = snap.size;
});
}

window.sendMsg = function(){
let text = document.getElementById("msgInput").value;
if(!text) return;

push(ref(db,"rooms/"+room+"/messages"),{
user:userId,
text:text,
time:Date.now()
});

document.getElementById("msgInput").value="";
}

window.typing = function(){
document.getElementById("typing").innerText="Typing...";
setTimeout(()=>document.getElementById("typing").innerText="",1000);
}

window.leaveRoom = function(){
remove(ref(db,"rooms/"+room+"/users/"+userId));
document.getElementById("leaveSound").play();
location.reload();
}

window.toggleTheme = function(){
document.body.classList.toggle("light");
}

window.startVoice = async function(){
let stream = await navigator.mediaDevices.getUserMedia({audio:true});
mediaRecorder = new MediaRecorder(stream);

voiceChunks=[];

mediaRecorder.ondataavailable=e=>voiceChunks.push(e.data);

mediaRecorder.onstop=e=>{
push(ref(db,"rooms/"+room+"/messages"),{
user:userId,
voice:true,
time:Date.now()
});
};

mediaRecorder.start();

setTimeout(()=>{
mediaRecorder.stop();
},60000); // 1 min max
}

</script>

</body>
</html>
