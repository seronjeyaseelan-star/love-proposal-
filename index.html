<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Chat Room</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body{margin:0;font-family:Arial;background:linear-gradient(135deg,#1e1f29,#0b141a);color:white;display:flex;flex-direction:column;align-items:center;min-height:100vh;}
.menu{display:flex;flex-direction:column;align-items:center;justify-content:center;width:95vw;max-width:400px;margin-top:50px;padding:20px;background:rgba(30,31,41,0.9);border-radius:12px;box-shadow:0 0 15px rgba(255,87,34,0.5);}
.menu h2{font-size:24px;margin-bottom:20px;color:#ff5722;text-shadow:0 0 8px orange;}
.menu input{width:100%;padding:15px;font-size:16px;border-radius:8px;border:none;margin:10px 0;}
.menu button{width:100%;padding:15px;margin:8px 0;font-size:18px;font-weight:bold;color:white;background:#ff5722;border:none;border-radius:10px;cursor:pointer;transition:all 0.3s;}
.menu button:hover{background:#e64a19;transform:scale(1.03);}
.roomCode{font-size:16px;margin-top:15px;text-align:center;}
.container{width:95vw;max-width:420px;aspect-ratio:9/16;background:#111b21;display:flex;flex-direction:column;border-radius:12px;overflow:hidden;margin-top:20px;box-shadow:0 0 20px rgba(255,87,34,0.4);}
header{background:#202c33;padding:12px;display:flex;justify-content:space-between;font-size:14px;align-items:center;}
#chat{flex:1;overflow-y:auto;padding:10px;background:#0f1b24;}
.msg{padding:8px;margin:6px;border-radius:10px;max-width:70%;word-wrap:break-word;}
.me{background:#005c4b;margin-left:auto;}
.other{background:#202c33;}
.controls{display:flex;gap:6px;padding:10px;background:#202c33;}
.controls input{flex:1;padding:12px;border-radius:8px;border:none;font-size:16px;}
.controls button{padding:12px;border-radius:8px;border:none;font-size:16px;cursor:pointer;background:#ff5722;color:white;font-weight:bold;transition:all 0.3s;}
.controls button:hover{background:#e64a19;}
.credit{margin-top:12px;color:#ff5722;font-size:14px;text-shadow:0 0 6px orange;text-align:center;}
/* Share popup */
#sharePopup{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;display:flex;justify-content:center;align-items:center;}
#sharePopup div{background:#202c33;padding:20px;border-radius:12px;text-align:center;color:white;max-width:90vw;}
#sharePopup h3{color:#ff5722;margin-bottom:12px;}
#sharePopup button{padding:12px 20px;font-size:16px;font-weight:bold;border:none;border-radius:8px;background:#ff5722;color:white;cursor:pointer;margin:5px;}
#sharePopup .closeBtn{background:#555;}
</style>
</head>
<body>

<!-- MENU -->
<div id="menu" class="menu">
<h2>Chat Room</h2>
<button onclick="createRoom()">Create Room</button>
<input id="joinCode" placeholder="Enter Room Code">
<button onclick="joinRoom()">Join Room</button>
<div id="roomDisplay" class="roomCode"></div>
<label>Destroy Timer (minutes, optional): <input id="destroyTimer" type="number" min="1" max="1440" placeholder="e.g. 10"></label>
</div>

<!-- CHAT PAGE -->
<div class="container" id="chatUI" style="display:none">
<header>
<div>Room: <span id="roomLabel"></span></div>
<div>
<button onclick="shareRoom()">Share</button>
<button id="adminBtn" onclick="destroyRoom()" style="display:none">Delete</button>
<button onclick="enterAdminCode()">Admin</button>
</div>
</header>

<div id="chat"></div>

<div class="controls">
<input id="msg" placeholder="Type message">
<button onclick="sendMsg()">Send</button>
<input type="file" id="imageInput" style="display:none" accept="image/*" onchange="sendImage(event)">
<button onclick="document.getElementById('imageInput').click()">Image</button>
<button id="voiceBtn" onclick="startVoice()">Voice</button>
<button onclick="leave()">Leave</button>
</div>
</div>

<div class="credit">Created by: Seron</div>

<!-- Share Popup -->
<div id="sharePopup">
<div>
<h3>Invite your friends!</h3>
<p>Share our website and chat with your friends.</p>
<button id="sharePopupBtn">Share Link</button>
<br>
<button class="closeBtn" onclick="closeSharePopup()">Close</button>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, push, onValue, remove, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// --- Firebase Config ---
const firebaseConfig = {
apiKey:"AIzaSyC4mYZ5G-WCjt7wAN0G6_B6rh1LDM10U0Q",
authDomain:"chat-data-59467.firebaseapp.com",
databaseURL:"https://chat-data-59467-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"chat-data-59467",
storageBucket:"chat-data-59467.appspot.com",
messagingSenderId:"237808362163",
appId:"1:237808362163:web:52d25dfbffaffde12446c6"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

let room="", user="Seron", isAdmin=false, adminCode="", destroyTimeout;

async function generateUniqueRoom(){
  const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
  let code="", exists=true;
  while(exists){
    code=""; for(let i=0;i<16;i++) code+=chars.charAt(Math.floor(Math.random()*chars.length));
    exists=(await get(ref(db,"rooms/"+code))).exists();
  }
  return code;
}

function generateAdminCode(){
  const digits=Math.floor(1000+Math.random()*9000);
  const letters=String.fromCharCode(65+Math.floor(Math.random()*26))+String.fromCharCode(65+Math.floor(Math.random()*26));
  return digits+letters;
}

async function createRoom(){
  room=await generateUniqueRoom();
  adminCode=generateAdminCode();
  isAdmin=true;
  const timerVal=parseInt(document.getElementById("destroyTimer").value);
  const destroyTime=timerVal?Date.now()+timerVal*60000:null;
  set(ref(db,"rooms/"+room),{adminCode:adminCode,destroyTime});
  document.getElementById("roomDisplay").innerHTML=`Room Code: ${room} <br> Admin Code: ${adminCode}`;
  document.getElementById("adminBtn").style.display="inline-block";
  startChat();
  showSharePopup(); // popup on create
  if(destroyTime) scheduleDestroy(destroyTime);
}

function joinRoom(){
  room=document.getElementById("joinCode").value;
  if(!room) return alert("Enter valid room code");
  isAdmin=false;
  document.getElementById("adminBtn").style.display="none";
  startChat();
  showSharePopup(); // popup on join
}

function startChat(){
  document.getElementById("menu").style.display="none";
  document.getElementById("chatUI").style.display="flex";
  document.getElementById("roomLabel").innerText=room;
  set(ref(db,"rooms/"+room+"/users/"+user),true);
  listenMessages();
  autoJoinFromLink();
}

function listenMessages(){
  onValue(ref(db,"rooms/"+room+"/messages"), snap=>{
    let chat=document.getElementById("chat");
    chat.innerHTML="";
    snap.forEach(m=>{
      let d=m.val();
      let div=document.createElement("div");
      div.className="msg "+(d.user==user?"me":"other");
      if(d.type==="text") div.innerText=d.user+": "+d.text;
      if(d.type==="image") div.innerHTML=d.user+":<br><img src='"+d.url+"' style='max-width:70%;border-radius:8px;'>";
      if(d.type==="voice") div.innerHTML=d.user+":<br><audio controls src='"+d.url+"'></audio>";
      chat.appendChild(div);
    });
    document.getElementById("chat").scrollTop=document.getElementById("chat").scrollHeight;
  });
}

function sendMsg(){
  const text=document.getElementById("msg").value;
  if(!text) return;
  push(ref(db,"rooms/"+room+"/messages"),{user:user,text,type:"text"});
  document.getElementById("msg").value="";
}

function sendImage(e){
  const file=e.target.files[0];
  if(!file) return;
  const storageRef=sRef(storage,"images/"+Date.now()+"_"+file.name);
  uploadBytes(storageRef,file).then(snapshot=>{
    getDownloadURL(snapshot.ref).then(url=>{
      push(ref(db,"rooms/"+room+"/messages"),{user:user,url,type:"image"});
    });
  });
}

let mediaRecorder, audioChunks=[];
function startVoice(){
  if(mediaRecorder && mediaRecorder.state==="recording"){ mediaRecorder.stop(); return; }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    mediaRecorder=new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);
    mediaRecorder.onstop=()=>{
      const blob=new Blob(audioChunks,{type:'audio/webm'});
      if(blob.size>1024*1024*5){alert("Max 1 min allowed");return;} 
      const storageRef=sRef(storage,"voice/"+Date.now()+".webm");
      uploadBytes(storageRef,blob).then(snapshot=>{
        getDownloadURL(snapshot.ref).then(url=>{
          push(ref(db,"rooms/"+room+"/messages"),{user:user,url,type:"voice"});
        });
      });
    };
    mediaRecorder.start();
    setTimeout(()=>{ if(mediaRecorder.state==="recording") mediaRecorder.stop(); },60000);
  });
}

function leave(){
  remove(ref(db,"rooms/"+room+"/users/"+user));
  location.href=location.pathname;
}

function destroyRoom(){
  if(!isAdmin) return;
  showSharePopup();
  setTimeout(()=>{
    remove(ref(db,"rooms/"+room));
    location.href=location.pathname;
  },1000);
}

function enterAdminCode(){
  const code=prompt("Enter Admin Code:");
  if(!code) return;
  get(ref(db,"rooms/"+room+"/adminCode")).then(snap=>{
    if(snap.val()===code){
      isAdmin=true;
      document.getElementById("adminBtn").style.display="inline-block";
      alert("You are now an admin!");
    } else alert("Incorrect code");
  });
}

function shareRoom(){
  let link=location.origin+location.pathname+"?room="+room;
  navigator.share?.({title:"Join Chat",text:"Join my room",url:link}) || alert(link);
}

// --- Share Popup ---
function showSharePopup(){
  document.getElementById("sharePopup").style.display="flex";
  document.getElementById("sharePopupBtn").onclick=()=>{
    let link=location.origin+location.pathname;
    if(navigator.share) navigator.share({title:"Join Chat",text:"Join my room",url:link});
    else prompt("Copy and share this link:",link);
  };
}
function closeSharePopup(){document.getElementById("sharePopup").style.display="none";}

// --- Auto join via URL ---
function autoJoinFromLink(){
  const params=new URLSearchParams(window.location.search);
  const r=params.get("room");
  if(r){room=r;isAdmin=false;document.getElementById("adminBtn").style.display="none";}
}

// --- Auto destroy timer ---
function scheduleDestroy(time){
  const delay=time-Date.now();
  if(delay>0) destroyTimeout=setTimeout(()=>destroyRoom(),delay);
}
</script>
</body>
</html>
